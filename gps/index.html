<!doctype html>

<head>
    <meta charset="utf-8">

    <title></title>

</head>

<body>
    <div id="app"></div>
    <button id="startbutton" style="height: 50px; width: 200px;" onclick="startExperience();">Start experience</button>
    <div id="coords"></div>
    <script>
        function startExperience() {
            document.getElementById('startbutton').remove();

            let audio = [];
            let app = document.getElementById('app');
            const firstAudio = 2;
            const lastAudio = 13;
            for (let i = firstAudio; i < (lastAudio + 1); i++) {
                let snippet = new Audio(`audio/${i}.mp3`);
                audio[i] = snippet;
            }

            let id;
            let targets = [{
                latitude: 52.4077429,
                longitude: 16.9171703,
                audio: 2,
                name: "zegar"
            },

            {
                latitude: 52.4089761,
                longitude: 16.9164174,
                audio: 3,
                name: "drzewo (park Mickiewicza)"
            },

            {
                latitude: 52.4089127,
                longitude: 16.9206315,
                audio: 4,
                name: "kamienica (przy Fredry)"
            },

            {
                latitude: 52.4088704,
                longitude: 16.9205041,
                audio: 5,
                name: "pomnik, mieszkaniec mickiewicza"
            },

            {
                latitude: 52.4080361,
                longitude: 16.9250059,
                audio: 6,
                name: "skrzyneczka (przy Arkadii)"
            },

            {
                latitude: 52.4067285,
                longitude: 16.9196671,
                audio: 7,
                name: "suka przybyszewskiego"
            },

            {
                latitude: 52.4082786,
                longitude: 16.9278782,
                audio: 8,
                name: "plac wolnosci - szachisci"
            },

            {
                latitude: 52.4092336,
                longitude: 16.9193353,
                audio: 9,
                name: "collegium maius"
            },

            {
                latitude: 52.409569,
                longitude: 16.9178729,
                audio: 10,
                name: "opera"
            },

            {
                latitude: 52.4080978,
                longitude: 16.9224462,
                audio: 11,
                name: "okraglak"
            },

            {
                latitude: 52.4068855,
                longitude: 16.9229834,
                audio: 12,
                name: "przejscie kantaka"
            },

            {
                latitude: 52.4071616,
                longitude: 16.9203245,
                audio: 13,
                name: "kolorking"
            },

            {
                latitude: 53.36566061450592,
                longitude: 14.605989128627435,
                audio: 2,
                name: "lapidarium"
            },
            {
                latitude: 53.363991291515184,
                longitude: 14.604128643780358,
                audio: 3,
                name: "park"
            },
            {
                latitude: 53.362189933283815,
                longitude: 14.603244143724053,
                audio: 4,
                name: "stalowa"
            },
            {
                latitude: 53.36279047047709,
                longitude: 14.606110431484815,
                audio: 5,
                name: "zeliwna"
            },
            {
                latitude: 53.36196120616845,
                longitude: 14.604947082053974,
                audio: 6,
                name: "stalowa-olkuska"
            }
            ];
            let options = {
                enableHighAccuracy: false,
                timeout: 5000,
                maximumAge: 0,
            };
            const MIN_DISTANCE = 0.0004;
            let isNear = (p1, p2) => {
                return Math.abs(p1.latitude - p2.latitude) <= MIN_DISTANCE && Math.abs(p1.longitude - p2.longitude) <= MIN_DISTANCE;
            }
            let playingAudioIndex = -1;
            const success = (pos) => {
                const crd = pos.coords;
                document.getElementById('coords').innerText = crd.latitude + " " + crd.longitude;
                targets.forEach(target => {
                    if (isNear(target, crd)) {
                        if (audio[target.audio].paused) {
                            audio[target.audio].play();
                            app.innerText = "You are in: " + target.name;
                        }
                        playingAudioIndex = target.audio;
                    }
                });

                for (let i = firstAudio; i < (lastAudio + 1); i++) {
                    if (i != playingAudioIndex && !(audio[i].paused)) {
                        audio[i].pause();
                    }
                }

            }

            //TO CHECK:
            //Instead of isNearDistance try setting up 4 points and checking if coordinates are inside polygon defined by them
            //Should audio stop if user gets far from the marker/leaves the area?

            const error = (err) => {
                console.error(`ERROR(${err.code}): ${err.message}`);
            }

            id = navigator.geolocation.watchPosition(success, error, options);
        }
    </script>
</body>