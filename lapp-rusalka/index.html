<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <script src="targets.js"></script>
  <script src="storage.js"></script>
  <title>Fonorama Rusa≈Çka</title>
  <style>
    html {
      height: 100%;
      background: black;
      background-size: 400% 400%;
    }

    #debugOverlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 30vh;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.85);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      display: none;
      z-index: 9999;
    }

    #debugOverlay h4 {
      margin-top: 0;
      color: #0ff;
    }

    #debugOverlay .log {
      white-space: pre-wrap;
      margin-top: 5px;
    }

    #gpsStatus {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 10000;
    }

    #debugToggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #eeeeee;
      color: black;
      border: none;
      border-radius: 5px;
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
      z-index: 10001;
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body
  style="height: 100%; padding: 0; margin: 10px; display: flex; flex-direction: column; align-items: center; font-family: Verdana, sans-serif;">

  <div id="gpsStatus" aria-live="polite">≈ÅƒÖczenie z GPS...</div>

  <img src="logo.png" alt="Logo aplikacji Fonorama Rusa≈Çka" width="30%" style="margin-bottom: 10vh; margin-top: 5vh">
  <div id="app" style="text-align: center; text-shadow: -20px -20px 10px rgba(255, 255, 255, 0.2);"></div>

  <button id="startbutton"
    style="height: 100px; width: 280px; font-size:150%; border-radius: 12px; background: #eeeeee; box-shadow: -20px -20px 10px rgba(255, 255, 255, 0.2);"
    onclick="startExperience();" aria-label="Rozpocznij do≈õwiadczenie">Rozpocznij</button>

  <button id="refreshbutton"
    style="height: 10%; width: 20%; font-size:150%; border-radius: 12px; background: #eeeeee; box-shadow: -20px -20px 10px rgba(255, 255, 255, 0.2); display: none;"
    aria-label="Od≈õwie≈º stronƒô">Od≈õwie≈º</button>

  <button id="pausebutton"
    style="margin-top: 50px; height: 10%; width: 20%; font-size:150%; border-radius: 12px; background: #eeeeee; box-shadow: -20px -20px 10px rgba(255, 255, 255, 0.2); display: none;"
    aria-label="Pauzuj lub wzn√≥w do≈õwiadczenie">Pauza</button>

  <div id="map" style="margin-top: 50px; height: 50%; width: 98%; margin-bottom: 10px;" aria-label="Mapa lokalizacji">
  </div>
  <div id="coords" style="font-size:300%; color: #eeeeee" aria-live="polite"></div>

  <div id="debugOverlay" aria-hidden="true">
    <h4>üõ†Ô∏è Tryb Debug</h4>
    <div><strong>Koordynaty:</strong> <span id="debugCoords">-</span></div>
    <div><strong>Audio:</strong> <span id="debugAudio">-</span></div>
    <div><strong>Miejsce:</strong> <span id="debugTarget">-</span></div>
    <div class="log" id="debugLog"></div>
  </div>

  <button id="debugToggle" onclick="toggleDebugOverlay()" aria-label="W≈ÇƒÖcz lub wy≈ÇƒÖcz tryb debugowania">Debug</button>

  <script>
    const MIN_DISTANCE = 0.0001;
    const playerStartPos = { latitude: 52.4109013, longitude: 16.906778 };
    const urlParams = new URLSearchParams(window.location.search);
    let DEV_MODE = urlParams.get('dev') === 'true';

    const audioMap = {};
    targets.forEach(t => {
      if (!audioMap[t.id]) {
        audioMap[t.id] = new Audio(`audio/${t.id}.mp3`);
        audioMap[t.id].preload = "auto"; // Preload audio
      }
    });

    const pauseAudio = new Audio("audio/pauza.mp3");

    const logDebug = (msg) => {
      //if (!DEV_MODE) return;
      const logBox = document.getElementById('debugLog');
      const newLine = document.createElement('div');
      newLine.textContent = msg;
      logBox.appendChild(newLine);
      logBox.scrollTop = logBox.scrollHeight;
    };

    const updateDebug = (coords, audio, targetName) => {
      if (!DEV_MODE) return;
      document.getElementById('debugCoords').innerText = `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
      document.getElementById('debugAudio').innerText = audio || "-";
      document.getElementById('debugTarget').innerText = targetName || "-";
    };

    function toggleDebugOverlay() {
      DEV_MODE = !DEV_MODE;
      if (DEV_MODE) {
        document.getElementById('debugOverlay').style.display = 'block';
      } else {
        document.getElementById('debugOverlay').style.display = 'none';
      }
    }

    function isNear(target, crd) {
      const dist = target.minDistance || MIN_DISTANCE;
      return (
        Math.abs(target.lat - crd.latitude) <= dist &&
        Math.abs(target.lng - crd.longitude) <= dist
      );
    }

    function startExperience() {
      document.getElementById('startbutton').remove();

      const refreshButton = document.getElementById('refreshbutton')
      refreshButton.style.display = 'block';

      const pauseButton = document.getElementById('pausebutton');
      pauseButton.style.display = 'block';

      const app = document.getElementById('app');
      const coordsDisplay = document.getElementById('coords');
      const gpsStatus = document.getElementById('gpsStatus');
      if (DEV_MODE) toggleDebugOverlay();

      let playingId = null;
      let isPaused = false;
      let watchId;

      const map = L.map('map').setView([playerStartPos.latitude, playerStartPos.longitude], 19);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 24,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const playerCircle = L.circle([playerStartPos.latitude, playerStartPos.longitude], {
        color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 2
      }).addTo(map);

      targets.filter(t => t.lat > 20).forEach(t => {
        // Add a marker for the target
        L.marker([t.lat, t.lng]).addTo(map).bindPopup(t.name);

        // Add a circle around the marker to represent the minimum distance
        const radius = (t.minDistance || MIN_DISTANCE) * 111000; // Convert degrees to meters
        L.circle([t.lat, t.lng], {
          color: 'blue',
          fillColor: '#30f',
          fillOpacity: 0.2,
          radius: radius
        }).addTo(map);
      });

      function playAudioForTarget(id, name, position) {
        if (!audioMap[id]) return;
        if (playingId === id) return; // Prevent re-triggering the same audio
        audioMap[id].play();
        app.innerText = `Znajdujesz siƒô w: ${name}`;
        playingId = id;
        if (position) {
          audioMap[id].currentTime = position;
        }
        updateDebug({ latitude: 0, longitude: 0 }, id, name);
      }

      function stopAllExcept(idToKeep) {
        Object.entries(audioMap).forEach(([id, audio]) => {
          if (id !== idToKeep && !audio.paused) {
            audio.pause();
          }
        });
      }

      const onPosition = pos => {
        const crd = pos.coords;
        gpsStatus.innerText = 'GPS Po≈ÇƒÖczony';
        coordsDisplay.innerText = `${crd.latitude.toFixed(6)}, ${crd.longitude.toFixed(6)}`;
        updateDebug(crd, playingId, targets.find(t => t.id === playingId)?.name);
        //logDebug(`üìç GPS: ${crd.latitude.toFixed(6)}, ${crd.longitude.toFixed(6)}`);

        for (const target of targets) {
          if (isNear(target, crd)) {
            //logDebug(`üéØ Blisko: ${target.name}`);
            if (audioMap[target.id].paused) {
              playAudioForTarget(target.id, target.name);
            }
            break;
          }
        }

        stopAllExcept(playingId);
        playerCircle.setLatLng([crd.latitude, crd.longitude]);
        map.setView([crd.latitude, crd.longitude]);
      };

      const onError = err => {
        logDebug(`ERROR(${err.code}): ${err.message}`);
        gpsStatus.innerText = 'B≈ÇƒÖd GPS';
        switch (err.code) {
          case 1:
            alert("Aplikacja potrzebuje dostƒôpu do GPS!");
            break;
          case 2:
            alert("Nie mo≈ºna uzyskaƒá pozycji GPS. Spr√≥buj ponownie.");
            break;
          case 3:
            alert("Czas oczekiwania na GPS up≈ÇynƒÖ≈Ç. Spr√≥buj ponownie.");
            break;
          default:
            alert("WystƒÖpi≈Ç nieznany b≈ÇƒÖd GPS.");
        }
      };

      watchId = navigator.geolocation.watchPosition(onPosition, onError, {
        enableHighAccuracy: true,
        timeout: 10000
      });

      if ('wakeLock' in navigator) {
        navigator.wakeLock.request("screen").catch(() => {
          alert("W trybie u≈õpienia nie ma mo≈ºliwo≈õci zbierania pozycji GPS. Po przybyciu do punktu odblokuj telefon.");
        });
      } else {
        alert("Twoje urzƒÖdzenie nie obs≈Çuguje blokady ekranu. Upewnij siƒô, ≈ºe ekran pozostaje w≈ÇƒÖczony.");
      }

      pauseButton.onclick = () => {
        if (isPaused) {
          watchId = navigator.geolocation.watchPosition(onPosition, onError, {
            enableHighAccuracy: true,
            timeout: 10000
          });
          pauseAudio.pause();
          pauseAudio.currentTime = 0;
          audioMap[playingId]?.play();
          pauseButton.innerText = "Pauza";
        } else {
          navigator.geolocation.clearWatch(watchId);
          audioMap[playingId]?.pause();
          pauseAudio.play();
          pauseButton.innerText = "Wzn√≥w";
        }
        isPaused = !isPaused;
      };

      refreshButton.onclick = () => {
        let currentlyPlaying = audioMap[playingId];
        if (currentlyPlaying) {
          let currentTime = currentlyPlaying.currentTime;
          storePlayingAudio(playingId, currentTime);
        }
        window.location.reload();
      };

      const hashTrigger = window.location.hash?.substring(1);
      if (hashTrigger) {
        const triggerLookup = {
          "lapp-rusalka-start-1": "QR_1_punkt startowy goleÃ®cin",
          "lapp-rusalka-start-2": "QR_2_punkt startowy osÃÅrodek",
          "lapp-rusalka-start-3": "QR_3_punkt startowy mostek bobrowy",
          "lapp-rusalka-start-4": "QR_4_punkt startowy plazÃáa nudystoÃÅw",
          "lapp-rusalka-start-5": "QR_5_punkt startowy ulica botaniczna",
        }
        const trigger = triggerLookup[hashTrigger];
        if (!trigger || !audioMap[trigger]) {
          logDebug(`üîó Nie znaleziono triggera dla ${hashTrigger}`);
          return;
        }
        logDebug(`üîó Odtw√≥rz z hash: ${hashTrigger}`);
        playAudioForTarget(hashTrigger, hashTrigger.replace(/-/g, ' '));
      } else {
        //fetch last played from localStorage
        //check if it exists and is not at the end
        // if it exists and wasn't at the end play it from position
        const lastPlayed = loadLastPlayingAudio();
        logDebug(`üîÑ Odtwarzanie ostatniego: ${lastPlayed ? `${lastPlayed.id}:${lastPlayed.position}` : 'brak'}`);
        if (lastPlayed && audioMap[lastPlayed.id]) {
          logDebug(`üîÑ Odtwarzanie ostatniego: ${lastPlayed.id}`);
          playAudioForTarget(lastPlayed.id, 'odtworzony ostatnio', lastPlayed.position);
        }
      }
    }
  </script>
</body>

</html>